#!/bin/bash
# ralphsetup - Initialize ralph2 in a project directory
# Usage: ralphsetup <directory>

set -e

RALPH2_DIR="/etc/agent-setup/tools/ralph2"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

usage() {
    echo "ralphsetup - Initialize ralph2 in a project directory"
    echo ""
    echo "Usage: ralphsetup <directory> [OPTIONS]"
    echo ""
    echo "Options:"
    echo "  --force, -f        Overwrite existing files"
    echo "  --tool <name>      Set default tool in ralph2.sh (amp|claude|codex)"
    echo "  --skip-skills      Don't install skills globally"
    echo "  --skills-only      Only install skills globally, skip project setup"
    echo "  --help, -h         Show this help"
    echo ""
    echo "Examples:"
    echo "  ralphsetup .                    # Initialize in current directory"
    echo "  ralphsetup /path/to/project     # Initialize in specific directory"
    echo "  ralphsetup . --tool codex       # Initialize with codex as default"
    echo "  ralphsetup --skills-only        # Just install global skills"
    echo ""
    echo "Files installed:"
    echo "  Project: scripts/ralph/         # ralph2.sh, prompts, prd.json"
    echo "  Global:  ~/.config/amp/skills/  # Amp skills (prd, ralph)"
    echo "  Global:  ~/.claude/skills/      # Claude Code skills (prd, ralph)"
    exit 0
}

# Check if ralph2 is installed
if [ ! -d "$RALPH2_DIR" ]; then
    echo -e "${RED}Error: ralph2 is not installed at $RALPH2_DIR${NC}"
    echo "Run the agent-setup installer first"
    exit 1
fi

# Parse arguments
TARGET_DIR=""
FORCE=false
DEFAULT_TOOL=""
SKIP_SKILLS=false
SKILLS_ONLY=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --help|-h)
            usage
            ;;
        --force|-f)
            FORCE=true
            shift
            ;;
        --tool)
            DEFAULT_TOOL="$2"
            shift 2
            ;;
        --skip-skills)
            SKIP_SKILLS=true
            shift
            ;;
        --skills-only)
            SKILLS_ONLY=true
            shift
            ;;
        *)
            if [ -z "$TARGET_DIR" ]; then
                TARGET_DIR="$1"
            else
                echo -e "${RED}Error: Unknown argument: $1${NC}"
                exit 1
            fi
            shift
            ;;
    esac
done

# Validate arguments
if [ "$SKILLS_ONLY" = false ] && [ -z "$TARGET_DIR" ]; then
    echo -e "${RED}Error: Target directory is required${NC}"
    echo "Usage: ralphsetup <directory>"
    echo "       ralphsetup --skills-only"
    exit 1
fi

# Function to copy file with check
copy_file() {
    local src="$1"
    local dst="$2"
    local name=$(basename "$src")

    if [ -f "$dst" ] && [ "$FORCE" != true ]; then
        echo -e "  ${YELLOW}[SKIP]${NC} $name (already exists, use --force to overwrite)"
        return
    fi

    if [ -f "$src" ]; then
        cp "$src" "$dst"
        echo -e "  ${GREEN}[COPY]${NC} $name"
    else
        echo -e "  ${RED}[MISS]${NC} $name (source not found)"
    fi
}

# Install skills globally
install_global_skills() {
    echo -e "${BLUE}Installing skills globally...${NC}"

    # Get the actual user's home directory (not root's when using sudo)
    if [ -n "$SUDO_USER" ]; then
        USER_HOME=$(getent passwd "$SUDO_USER" | cut -d: -f6)
    else
        USER_HOME="$HOME"
    fi

    # Amp skills directory
    AMP_SKILLS_DIR="$USER_HOME/.config/amp/skills"
    if [ -d "$RALPH2_DIR/skills" ]; then
        echo -e "  ${BLUE}Amp skills -> $AMP_SKILLS_DIR${NC}"
        mkdir -p "$AMP_SKILLS_DIR"

        for skill_dir in "$RALPH2_DIR/skills/"*/; do
            skill_name=$(basename "$skill_dir")
            if [ -d "$AMP_SKILLS_DIR/$skill_name" ] && [ "$FORCE" != true ]; then
                echo -e "    ${YELLOW}[SKIP]${NC} $skill_name (exists)"
            else
                cp -r "$skill_dir" "$AMP_SKILLS_DIR/"
                echo -e "    ${GREEN}[COPY]${NC} $skill_name"
            fi
        done

        # Fix ownership if running as sudo
        if [ -n "$SUDO_USER" ]; then
            chown -R "$SUDO_USER:$SUDO_USER" "$USER_HOME/.config/amp" 2>/dev/null || true
        fi
    fi

    # Claude Code skills directory
    CLAUDE_SKILLS_DIR="$USER_HOME/.claude/skills"
    if [ -d "$RALPH2_DIR/skills" ]; then
        echo -e "  ${BLUE}Claude skills -> $CLAUDE_SKILLS_DIR${NC}"
        mkdir -p "$CLAUDE_SKILLS_DIR"

        for skill_dir in "$RALPH2_DIR/skills/"*/; do
            skill_name=$(basename "$skill_dir")
            if [ -d "$CLAUDE_SKILLS_DIR/$skill_name" ] && [ "$FORCE" != true ]; then
                echo -e "    ${YELLOW}[SKIP]${NC} $skill_name (exists)"
            else
                cp -r "$skill_dir" "$CLAUDE_SKILLS_DIR/"
                echo -e "    ${GREEN}[COPY]${NC} $skill_name"
            fi
        done

        # Fix ownership if running as sudo
        if [ -n "$SUDO_USER" ]; then
            chown -R "$SUDO_USER:$SUDO_USER" "$USER_HOME/.claude" 2>/dev/null || true
        fi
    fi

    echo -e "  ${GREEN}[DONE]${NC} Global skills installed"
}

echo ""
echo -e "${CYAN}========================================"
echo -e "  Ralph2 Setup"
echo -e "========================================${NC}"
echo ""

# Install global skills (unless skipped)
if [ "$SKIP_SKILLS" = false ]; then
    install_global_skills
    echo ""
fi

# Exit if skills-only mode
if [ "$SKILLS_ONLY" = true ]; then
    echo -e "${GREEN}Skills installation complete!${NC}"
    echo ""
    echo "Skills installed to:"
    echo "  - ~/.config/amp/skills/prd"
    echo "  - ~/.config/amp/skills/ralph"
    echo "  - ~/.claude/skills/prd"
    echo "  - ~/.claude/skills/ralph"
    echo ""
    echo "Use '/prd' to generate PRDs and '/ralph' to convert to JSON."
    exit 0
fi

# Create directory if it doesn't exist
if [ ! -d "$TARGET_DIR" ]; then
    echo -e "${BLUE}Creating directory: $TARGET_DIR${NC}"
    mkdir -p "$TARGET_DIR"
fi

# Convert to absolute path
TARGET_DIR="$(cd "$TARGET_DIR" && pwd)"

# Create scripts/ralph subdirectory (following ralph convention)
SCRIPTS_DIR="$TARGET_DIR/scripts/ralph"
mkdir -p "$SCRIPTS_DIR"

echo "Target: $TARGET_DIR"
echo ""

# Copy ralph2.sh
echo -e "${BLUE}Copying ralph2 script...${NC}"
copy_file "$RALPH2_DIR/ralph2.sh" "$SCRIPTS_DIR/ralph2.sh"
chmod +x "$SCRIPTS_DIR/ralph2.sh" 2>/dev/null || true

# Copy PRD example
echo -e "${BLUE}Copying PRD template...${NC}"
copy_file "$RALPH2_DIR/prd.json.example" "$SCRIPTS_DIR/prd.json.example"

# Copy agent instruction files
echo -e "${BLUE}Copying agent instruction files...${NC}"
copy_file "$RALPH2_DIR/prompt.md" "$SCRIPTS_DIR/prompt.md"
copy_file "$RALPH2_DIR/CLAUDE.md" "$SCRIPTS_DIR/CLAUDE.md"
copy_file "$RALPH2_DIR/CODEX.md" "$SCRIPTS_DIR/CODEX.md"
copy_file "$RALPH2_DIR/AGENTS.md" "$SCRIPTS_DIR/AGENTS.md"

# Create progress.txt if it doesn't exist
if [ ! -f "$SCRIPTS_DIR/progress.txt" ]; then
    echo -e "${BLUE}Creating progress log...${NC}"
    cat > "$SCRIPTS_DIR/progress.txt" << EOF
# Ralph2 Progress Log
Initialized: $(date)
Project: $(basename "$TARGET_DIR")
---

## Codebase Patterns
(Add reusable patterns discovered during development)

---
EOF
    echo -e "  ${GREEN}[CREATE]${NC} progress.txt"
fi

# Apply default tool if specified
if [ -n "$DEFAULT_TOOL" ]; then
    echo -e "${BLUE}Setting default tool to: $DEFAULT_TOOL${NC}"
    if [ -f "$SCRIPTS_DIR/ralph2.sh" ]; then
        sed -i "s/^TOOL=\"claude\"/TOOL=\"$DEFAULT_TOOL\"/" "$SCRIPTS_DIR/ralph2.sh"
        echo -e "  ${GREEN}[SET]${NC} Default tool: $DEFAULT_TOOL"
    fi
fi

# Create symlink to ralph2 in project root for convenience
if [ ! -f "$TARGET_DIR/ralph2" ] || [ "$FORCE" = true ]; then
    ln -sf "scripts/ralph/ralph2.sh" "$TARGET_DIR/ralph2" 2>/dev/null || true
    echo -e "${BLUE}Created symlink: ./ralph2${NC}"
fi

# Create AGENTS.md in project root if it doesn't exist
if [ ! -f "$TARGET_DIR/AGENTS.md" ]; then
    echo -e "${BLUE}Creating root AGENTS.md...${NC}"
    cat > "$TARGET_DIR/AGENTS.md" << 'EOF'
# Project Agent Instructions

## Ralph2 Integration

This project uses ralph2 for autonomous AI agent loops.

### Quick Start
```bash
# Check status
./ralph2 --status

# List all tasks
./ralph2 --list

# Run the agent loop
./ralph2 --tool claude  # or: amp, codex
```

### Files
- `scripts/ralph/` - Ralph2 configuration and scripts
- `scripts/ralph/prd.json` - Product Requirements Document
- `scripts/ralph/progress.txt` - Progress log with learnings

### Notifications
Use `alertme` and `promptme` for communication:
```bash
alertme --title "Done" --description "Task complete" --status success
ANSWER=$(promptme --title "Question" --description "Need input" --timeout 300)
```

## Codebase Patterns
(Add project-specific patterns for agents here)

EOF
    echo -e "  ${GREEN}[CREATE]${NC} AGENTS.md"
fi

echo ""
echo -e "${GREEN}========================================"
echo -e "  Setup Complete!"
echo -e "========================================${NC}"
echo ""
echo "Next steps:"
echo "  1. Copy prd.json.example to prd.json and customize:"
echo "     cp $SCRIPTS_DIR/prd.json.example $SCRIPTS_DIR/prd.json"
echo ""
echo "  2. Edit prd.json with your user stories"
echo ""
echo "  3. Run ralph2:"
echo "     cd $TARGET_DIR"
echo "     ./ralph2 --status      # Check setup"
echo "     ./ralph2               # Start agent loop"
echo ""
echo "  4. Monitor progress:"
echo "     ./ralph2 --list        # See all tasks"
echo "     cat scripts/ralph/progress.txt"
echo ""
