#!/bin/bash
# Telegram Bot Setup Script
# Configures the Agent Telegram Bot

set -e

CONFIG_DIR="/etc/hive"
CONFIG_FILE="$CONFIG_DIR/telegram_config.json"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

echo -e "${CYAN}"
echo "========================================"
echo "  Agent Telegram Bot Setup"
echo "========================================"
echo -e "${NC}"

# Check if running as root for system config
if [ "$EUID" -ne 0 ]; then
    echo -e "${YELLOW}[WARN]${NC} Running without root. Config will be saved to user directory."
    CONFIG_DIR="$HOME/.config/hive"
    CONFIG_FILE="$CONFIG_DIR/telegram_config.json"
fi

mkdir -p "$CONFIG_DIR"

# Check if already configured
if [ -f "$CONFIG_FILE" ]; then
    CURRENT_BOUND=$(jq -r '.bound // false' "$CONFIG_FILE" 2>/dev/null)
    if [ "$CURRENT_BOUND" = "true" ]; then
        echo -e "${GREEN}Bot is already configured and bound!${NC}"
        echo ""
        CURRENT_CHAT=$(jq -r '.chat_id // "unknown"' "$CONFIG_FILE")
        echo "Chat ID: $CURRENT_CHAT"
        echo ""
        read -p "Do you want to reconfigure? (y/N): " RECONFIGURE
        if [ "$RECONFIGURE" != "y" ] && [ "$RECONFIGURE" != "Y" ]; then
            echo "Keeping existing configuration."
            exit 0
        fi
    fi
fi

echo ""
echo -e "${BLUE}Step 1: Create a Telegram Bot${NC}"
echo "----------------------------------------"
echo "1. Open Telegram and search for @BotFather"
echo "2. Send /newbot and follow the instructions"
echo "3. Copy the bot token (looks like: 123456789:ABCdefGHIjklMNOpqrsTUVwxyz)"
echo ""

read -p "Enter your bot token: " BOT_TOKEN

if [ -z "$BOT_TOKEN" ]; then
    echo -e "${RED}[ERROR]${NC} Bot token cannot be empty"
    exit 1
fi

# Validate token format
if ! echo "$BOT_TOKEN" | grep -qE "^[0-9]+:[A-Za-z0-9_-]+$"; then
    echo -e "${YELLOW}[WARN]${NC} Token format looks unusual, but continuing..."
fi

echo ""
echo -e "${BLUE}Step 2: Set Binding Phrase${NC}"
echo "----------------------------------------"
echo "This is a secret phrase you'll send to the bot to link it to your chat."
echo "Default: BIND_AGENT_BOT"
echo ""

read -p "Enter binding phrase (press Enter for default): " BINDING_PHRASE
BINDING_PHRASE=${BINDING_PHRASE:-BIND_AGENT_BOT}

# Save initial config
cat > "$CONFIG_FILE" << EOF
{
    "bot_token": "$BOT_TOKEN",
    "chat_id": "",
    "binding_phrase": "$BINDING_PHRASE",
    "bound": false
}
EOF

chmod 600 "$CONFIG_FILE"

echo ""
echo -e "${GREEN}[SUCCESS]${NC} Configuration saved!"
echo ""
echo -e "${BLUE}Step 3: Start the Bot Service${NC}"
echo "----------------------------------------"

if [ "$EUID" -eq 0 ]; then
    echo "Starting the telegram bot service..."
    systemctl enable agent-telegram-bot
    systemctl restart agent-telegram-bot

    # Wait for service to start
    sleep 2

    if systemctl is-active --quiet agent-telegram-bot; then
        echo -e "${GREEN}[SUCCESS]${NC} Service started successfully!"
    else
        echo -e "${RED}[ERROR]${NC} Service failed to start. Check logs with:"
        echo "  journalctl -u agent-telegram-bot -f"
        exit 1
    fi
else
    echo -e "${YELLOW}[INFO]${NC} Run as root to start the systemd service, or run manually:"
    echo "  python3 $CONFIG_DIR/agent_telegram_bot.py"
fi

echo ""
echo -e "${BLUE}Step 4: Bind the Bot to Your Chat${NC}"
echo "----------------------------------------"
echo "1. Open Telegram and find your bot (search for its username)"
echo "2. Start a conversation with /start"
echo "3. Send the binding phrase: $BINDING_PHRASE"
echo ""
echo "The bot will confirm when binding is successful."
echo ""

echo -e "${CYAN}"
echo "========================================"
echo "  Setup Complete!"
echo "========================================"
echo -e "${NC}"
echo ""
echo "After binding, you can use:"
echo "  alertme --title 'Test' --description 'Hello' --status success"
echo "  promptme --title 'Question' --description 'Yes or no?' --timeout 60"
echo ""
echo "Check service status: systemctl status agent-telegram-bot"
echo "View logs: journalctl -u agent-telegram-bot -f"
