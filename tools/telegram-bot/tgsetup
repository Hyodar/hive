#!/bin/bash
# Telegram Bot Setup Script
# Collects bot token and chat ID for Telegram notifications

set -e

CONFIG_DIR="/etc/hive"
CONFIG_FILE="$CONFIG_DIR/telegram_config.json"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

echo -e "${CYAN}"
echo "========================================"
echo "  Telegram Bot Setup"
echo "========================================"
echo -e "${NC}"

# Check if running as root for system config
if [ "$EUID" -ne 0 ]; then
    echo -e "${YELLOW}[WARN]${NC} Running without root. Config will be saved to user directory."
    CONFIG_DIR="$HOME/.config/hive"
    CONFIG_FILE="$CONFIG_DIR/telegram_config.json"
fi

mkdir -p "$CONFIG_DIR"

# Check if already configured
if [ -f "$CONFIG_FILE" ]; then
    CURRENT_TOKEN=$(jq -r '.bot_token // ""' "$CONFIG_FILE" 2>/dev/null)
    CURRENT_CHAT=$(jq -r '.chat_id // ""' "$CONFIG_FILE" 2>/dev/null)
    if [ -n "$CURRENT_TOKEN" ] && [ -n "$CURRENT_CHAT" ]; then
        echo -e "${GREEN}Telegram is already configured.${NC}"
        echo ""
        echo "Chat ID: $CURRENT_CHAT"
        echo ""
        read -p "Do you want to reconfigure? (y/N): " RECONFIGURE
        if [ "$RECONFIGURE" != "y" ] && [ "$RECONFIGURE" != "Y" ]; then
            echo "Keeping existing configuration."
            exit 0
        fi
    fi
fi

echo ""
echo -e "${BLUE}Step 1: Bot Token${NC}"
echo "----------------------------------------"
echo "1. Open Telegram and search for @BotFather"
echo "2. Send /newbot and follow the instructions"
echo "3. Copy the bot token (looks like: 123456789:ABCdefGHIjklMNOpqrsTUVwxyz)"
echo ""

read -p "Enter your bot token: " BOT_TOKEN

if [ -z "$BOT_TOKEN" ]; then
    echo -e "${RED}[ERROR]${NC} Bot token cannot be empty"
    exit 1
fi

# Validate token format
if ! echo "$BOT_TOKEN" | grep -qE "^[0-9]+:[A-Za-z0-9_-]+$"; then
    echo -e "${YELLOW}[WARN]${NC} Token format looks unusual, but continuing..."
fi

echo ""
echo -e "${BLUE}Step 2: Chat ID${NC}"
echo "----------------------------------------"
echo "To get your chat ID:"
echo "1. Send a message to your bot on Telegram"
echo "2. Visit: https://api.telegram.org/bot<YOUR_TOKEN>/getUpdates"
echo "3. Look for \"chat\":{\"id\":YOUR_CHAT_ID}"
echo ""

read -p "Enter your chat ID: " CHAT_ID

if [ -z "$CHAT_ID" ]; then
    echo -e "${RED}[ERROR]${NC} Chat ID cannot be empty"
    exit 1
fi

# Save config
cat > "$CONFIG_FILE" << EOF
{
    "bot_token": "$BOT_TOKEN",
    "chat_id": "$CHAT_ID",
    "bound": true
}
EOF

chmod 600 "$CONFIG_FILE"

echo ""
echo -e "${GREEN}[OK]${NC} Telegram configuration saved!"
echo ""
echo "You can use:"
echo "  alertme --title 'Test' --description 'Hello' --status success"
echo "  promptme --title 'Question' --description 'Yes or no?' --timeout 60"
echo ""
