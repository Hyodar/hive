#!/bin/bash
# ralphsetup - Initialize ralph2 in a project directory
# Usage: ralphsetup <directory>

set -e

RALPH2_DIR="/etc/agent-setup/ralph2"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

usage() {
    echo "ralphsetup - Initialize ralph2 in a project directory"
    echo ""
    echo "Usage: ralphsetup <directory> [OPTIONS]"
    echo ""
    echo "Options:"
    echo "  --force, -f     Overwrite existing files"
    echo "  --minimal       Only copy essential files (ralph2.sh, prd.json.example)"
    echo "  --tool <name>   Set default tool in ralph2.sh (amp|claude|codex)"
    echo "  --help, -h      Show this help"
    echo ""
    echo "Examples:"
    echo "  ralphsetup .                    # Initialize in current directory"
    echo "  ralphsetup /path/to/project     # Initialize in specific directory"
    echo "  ralphsetup . --tool codex       # Initialize with codex as default"
    exit 0
}

# Check if ralph2 is installed
if [ ! -d "$RALPH2_DIR" ]; then
    echo -e "${RED}Error: ralph2 is not installed at $RALPH2_DIR${NC}"
    echo "Run the agent-setup installer first"
    exit 1
fi

# Parse arguments
TARGET_DIR=""
FORCE=false
MINIMAL=false
DEFAULT_TOOL=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --help|-h)
            usage
            ;;
        --force|-f)
            FORCE=true
            shift
            ;;
        --minimal)
            MINIMAL=true
            shift
            ;;
        --tool)
            DEFAULT_TOOL="$2"
            shift 2
            ;;
        *)
            if [ -z "$TARGET_DIR" ]; then
                TARGET_DIR="$1"
            else
                echo -e "${RED}Error: Unknown argument: $1${NC}"
                exit 1
            fi
            shift
            ;;
    esac
done

# Validate target directory
if [ -z "$TARGET_DIR" ]; then
    echo -e "${RED}Error: Target directory is required${NC}"
    echo "Usage: ralphsetup <directory>"
    exit 1
fi

# Create directory if it doesn't exist
if [ ! -d "$TARGET_DIR" ]; then
    echo -e "${BLUE}Creating directory: $TARGET_DIR${NC}"
    mkdir -p "$TARGET_DIR"
fi

# Convert to absolute path
TARGET_DIR="$(cd "$TARGET_DIR" && pwd)"

# Create scripts subdirectory
SCRIPTS_DIR="$TARGET_DIR/scripts/ralph2"
mkdir -p "$SCRIPTS_DIR"

echo ""
echo -e "${CYAN}========================================"
echo -e "  Ralph2 Setup"
echo -e "========================================${NC}"
echo ""
echo "Target: $TARGET_DIR"
echo ""

# Function to copy file with check
copy_file() {
    local src="$1"
    local dst="$2"
    local name=$(basename "$src")

    if [ -f "$dst" ] && [ "$FORCE" != true ]; then
        echo -e "  ${YELLOW}[SKIP]${NC} $name (already exists, use --force to overwrite)"
        return
    fi

    if [ -f "$src" ]; then
        cp "$src" "$dst"
        echo -e "  ${GREEN}[COPY]${NC} $name"
    else
        echo -e "  ${RED}[MISS]${NC} $name (source not found)"
    fi
}

# Copy ralph2.sh
echo -e "${BLUE}Copying ralph2 script...${NC}"
copy_file "$RALPH2_DIR/ralph2.sh" "$SCRIPTS_DIR/ralph2.sh"
chmod +x "$SCRIPTS_DIR/ralph2.sh" 2>/dev/null || true

# Copy PRD example
echo -e "${BLUE}Copying PRD template...${NC}"
copy_file "$RALPH2_DIR/prd.json.example" "$SCRIPTS_DIR/prd.json.example"

if [ "$MINIMAL" != true ]; then
    # Copy agent instruction files
    echo -e "${BLUE}Copying agent instruction files...${NC}"
    copy_file "$RALPH2_DIR/prompt.md" "$SCRIPTS_DIR/prompt.md"
    copy_file "$RALPH2_DIR/CLAUDE.md" "$SCRIPTS_DIR/CLAUDE.md"
    copy_file "$RALPH2_DIR/CODEX.md" "$SCRIPTS_DIR/CODEX.md"
    copy_file "$RALPH2_DIR/AGENTS.md" "$SCRIPTS_DIR/AGENTS.md"

    # Copy skills if they exist
    if [ -d "$RALPH2_DIR/skills" ] && [ "$(ls -A $RALPH2_DIR/skills 2>/dev/null)" ]; then
        echo -e "${BLUE}Copying skills...${NC}"
        mkdir -p "$SCRIPTS_DIR/skills"
        cp -r "$RALPH2_DIR/skills/"* "$SCRIPTS_DIR/skills/" 2>/dev/null || true
        echo -e "  ${GREEN}[COPY]${NC} skills/"
    fi
fi

# Create progress.txt if it doesn't exist
if [ ! -f "$SCRIPTS_DIR/progress.txt" ]; then
    echo -e "${BLUE}Creating progress log...${NC}"
    cat > "$SCRIPTS_DIR/progress.txt" << EOF
# Ralph2 Progress Log
Initialized: $(date)
Project: $(basename "$TARGET_DIR")
---

## Codebase Patterns
(Add reusable patterns discovered during development)

---
EOF
    echo -e "  ${GREEN}[CREATE]${NC} progress.txt"
fi

# Apply default tool if specified
if [ -n "$DEFAULT_TOOL" ]; then
    echo -e "${BLUE}Setting default tool to: $DEFAULT_TOOL${NC}"
    if [ -f "$SCRIPTS_DIR/ralph2.sh" ]; then
        sed -i "s/^TOOL=\"claude\"/TOOL=\"$DEFAULT_TOOL\"/" "$SCRIPTS_DIR/ralph2.sh"
        echo -e "  ${GREEN}[SET]${NC} Default tool: $DEFAULT_TOOL"
    fi
fi

# Create symlink to ralph2 in project root for convenience
if [ ! -f "$TARGET_DIR/ralph2" ] || [ "$FORCE" = true ]; then
    ln -sf "scripts/ralph2/ralph2.sh" "$TARGET_DIR/ralph2" 2>/dev/null || true
    echo -e "${BLUE}Created symlink: ./ralph2${NC}"
fi

# Create AGENTS.md in project root if it doesn't exist
if [ ! -f "$TARGET_DIR/AGENTS.md" ]; then
    echo -e "${BLUE}Creating root AGENTS.md...${NC}"
    cat > "$TARGET_DIR/AGENTS.md" << 'EOF'
# Project Agent Instructions

## Ralph2 Integration

This project uses ralph2 for autonomous AI agent loops.

### Quick Start
```bash
# Check status
./ralph2 --status

# List all tasks
./ralph2 --list

# Run the agent loop
./ralph2 --tool claude  # or: amp, codex
```

### Files
- `scripts/ralph2/` - Ralph2 configuration and scripts
- `scripts/ralph2/prd.json` - Product Requirements Document
- `scripts/ralph2/progress.txt` - Progress log with learnings

### Notifications
Use `alertme` and `promptme` for communication:
```bash
alertme --title "Done" --description "Task complete" --status success
ANSWER=$(promptme --title "Question" --description "Need input" --timeout 300)
```

## Codebase Patterns
(Add project-specific patterns for agents here)

EOF
    echo -e "  ${GREEN}[CREATE]${NC} AGENTS.md"
fi

echo ""
echo -e "${GREEN}========================================"
echo -e "  Setup Complete!"
echo -e "========================================${NC}"
echo ""
echo "Next steps:"
echo "  1. Copy prd.json.example to prd.json and customize:"
echo "     cp $SCRIPTS_DIR/prd.json.example $SCRIPTS_DIR/prd.json"
echo ""
echo "  2. Edit prd.json with your user stories"
echo ""
echo "  3. Run ralph2:"
echo "     cd $TARGET_DIR"
echo "     ./ralph2 --status      # Check setup"
echo "     ./ralph2               # Start agent loop"
echo ""
echo "  4. Monitor progress:"
echo "     ./ralph2 --list        # See all tasks"
echo "     cat scripts/ralph2/progress.txt"
echo ""
